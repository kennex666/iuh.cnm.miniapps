<!DOCTYPE html>
<html lang="vi">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Mini Grab</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
	<style>
		body {
			font-family: 'Inter', sans-serif;
		}
	</style>
</head>
<body class="bg-gradient-to-tr from-green-50 to-blue-50 min-h-screen flex items-center justify-center">

	<!-- Loading -->
	<div id="loading" class="text-center text-green-600 text-lg font-semibold animate-pulse">
		🚦 Đang khởi động ứng dụng...
	</div>

	<!-- Giao diện chính -->
	<div id="main" class="hidden w-full max-w-md bg-white rounded-3xl shadow-xl p-6 space-y-6">
		<!-- Thông tin người dùng -->
		<div class="flex items-center space-x-4">
			<img id="avatar" src="" class="w-16 h-16 rounded-full border-4 border-green-200 shadow" />
			<div>
				<p class="text-xl font-bold text-gray-900" id="username">Tên</p>
				<p class="text-sm text-gray-500">SĐT: <span id="account">...</span></p>
			</div>
		</div>

		<!-- Vị trí -->
		<div class="flex items-center justify-between">
			<div>
				<p class="text-xs text-gray-500">Vị trí hiện tại:</p>
				<p id="location" class="text-sm font-semibold text-gray-700">Đang xác minh...</p>
			</div>
			<button onclick="requestLocationPermission()" class="text-xs text-green-600 underline">
				<i class="fas fa-map-marker-alt"></i> Cập nhật vị trí
			</button>
		</div>

		<!-- Dịch vụ -->
		<div>
			<h3 class="text-base font-semibold text-gray-700 mb-2">Dịch vụ của bạn</h3>
			<div class="grid grid-cols-3 gap-4 text-center text-sm text-gray-700">
				<button class="p-4 bg-gray-50 rounded-xl shadow hover:bg-green-50 transition" onclick="book('Gọi xe')">
					<i class="fas fa-car text-lg mb-1 text-green-500"></i>
					<p>Gọi xe</p>
				</button>
				<button class="p-4 bg-gray-50 rounded-xl shadow hover:bg-green-50 transition" onclick="book('Giao đồ ăn')">
					<i class="fas fa-hamburger text-lg mb-1 text-green-500"></i>
					<p>Đồ ăn</p>
				</button>
				<button class="p-4 bg-gray-50 rounded-xl shadow hover:bg-green-50 transition" onclick="book('Mua hộ')">
					<i class="fas fa-shopping-basket text-lg mb-1 text-green-500"></i>
					<p>Mua hộ</p>
				</button>
			</div>
		</div>

		<!-- Trạng thái -->
		<div id="status" class="text-sm text-gray-600 text-center italic"></div>
	</div>

	<script>
		let hasLocationPermission = false;

		function requestLocationPermission() {
			window.ReactNativeWebView?.postMessage(JSON.stringify({
				type: "REQUIRE_PERMISSIONS",
				data: "location"
			}));
			document.getElementById("location").innerText = "Đang yêu cầu quyền truy cập vị trí...";
		}

		function book(service) {
			if (!hasLocationPermission) {
				alert("⚠️ Không thể sử dụng dịch vụ khi chưa cấp quyền vị trí!");
				return;
			}
			document.getElementById("status").innerText = `🚗 Đang xử lý dịch vụ "${service}"...`;
			setTimeout(() => {
				document.getElementById("status").innerText = `✅ Dịch vụ "${service}" đã được đặt thành công!`;
			}, 2000);
		}

		function initUser(data) {
			const { name, phone, avatarURL } = data;
			document.getElementById("loading").classList.add("hidden");
			document.getElementById("main").classList.remove("hidden");

			document.getElementById("username").innerText = name;
			document.getElementById("account").innerText = phone;
			document.getElementById("avatar").src = avatarURL || `https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(name)}`;
		}

		window.onload = function () {
			window.ReactNativeWebView?.postMessage(JSON.stringify({ type: "READY" }));

			window.addEventListener("message", function (event) {
				try {
					const data = typeof event.data === "string" ? JSON.parse(event.data) : event.data;

					if (data?.type === "ACCEPT_PERMISSIONS" && data.data.permission === "location") {
						hasLocationPermission = true;
						document.getElementById("location").innerText = "📍 123 Đường Demo, TP.HCM";
						document.getElementById("status").innerText = "✅ Đã xác định vị trí!";
					} else if (data?.type === "DENY_PERMISSIONS") {
						hasLocationPermission = false;
						document.getElementById("location").innerText = "❌ Quyền vị trí bị từ chối";
						document.getElementById("status").innerText = "Bạn cần cấp quyền để sử dụng dịch vụ.";
					} else {
						initUser(data);
					}
				} catch (e) {
					console.warn("Lỗi khi parse message:", event.data);
				}
			});
		};
	</script>
</body>
</html>
